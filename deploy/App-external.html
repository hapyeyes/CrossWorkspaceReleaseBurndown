<!DOCTYPE html>
<html>
<head>
    <title>CrossWorkspaceReleaseBurndown</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CrossWorkspaceBurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var me=this,completedScheduleStateNames=this.getCompletedScheduleStateNames(),workspacePoints,data=[{as:"AcceptedPoints",f:function(snapshot){var ss=snapshot.ScheduleState;return completedScheduleStateNames.indexOf(ss)>-1&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"TotalBacklog",f:function(snapshot){return snapshot.PlanEstimate?snapshot.PlanEstimate:0}}];for(var workspace in me.selectedRelease.Workspaces)workspacePoints=[{as:workspace._refObjectName+" Accepted points",f:function(snapshot){var ss=snapshot.ScheduleState;return snapshot.workspace===workspace.ref&&completedScheduleStateNames.indexOf(ss)>-1&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:workspace._refObjectName+" Total Backlog",f:function(snapshot){return snapshot.workspace===workspace.ref&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}}],data.concat(workspacePoints);return data},getMetrics:function(){var me=this,workspaceMetrics,metrics=[{field:"AcceptedPoints",as:"Accepted",f:"sum",display:"line"},{field:"TotalBacklog",as:"Total Backlog",f:"sum",display:"line"}];for(var workspace in me.selectedRelease.Workspaces)workspaceMetrics=[{field:workspace._refObjectName+" AcceptedPoints",as:workspace._refObjectName+" Accepted",f:"sum",display:"line"},{field:workspace._refObjectName+" TotalBacklog",as:workspace._refObjectName+" Total Backlog",f:"sum",display:"line"}],metrics.concat(workspaceMetrics);return metrics},getDerivedFieldsAfterSummary:function(){return[{as:"Accepted Prediction",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"},{as:"Total Backlog Prediction",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"},{as:"Forecast Velocity",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"}]},getProjectionsConfig:function(){var days=(this.scopeEndDate.getTime()-Rally.util.DateTime.fromIsoString(this.startDate).getTime())/864e5,doubleTimeboxEnd=Ext.Date.add(Rally.util.DateTime.fromIsoString(this.startDate),Ext.Date.DAY,2*Math.floor(days)-1),timeboxEnd=Ext.Date.add(this.scopeEndDate,Ext.Date.DAY,-1);return void 0===this.projectionsConfig&&(this.projectionsConfig={doubleTimeboxEnd:doubleTimeboxEnd,timeboxEnd:timeboxEnd,series:[{as:"Accepted Prediction",field:"Accepted"},{as:"Total Backlog Prediction",field:"Total Backlog",slope:0}],continueWhile:function(point){var dt=Rally.util.DateTime.fromIsoString(point.tick),end=this.series[0].slope>=0?this.timeboxEnd:this.doubleTimeboxEnd;return end>dt}}),this.projectionsConfig},_firstNonZero:function(data){var i;for(i=0;data.length>i;i++)if(data[i]>0)return i;return 0},prepareChartData:function(store){var snapshots=[],raw;console.log(store);for(var i in store)store[i].each(function(record){raw=record.raw,raw.workspace=store[i].context.workspace,snapshots.push(raw)});return this.runCalculation(snapshots)},runCalculation:function(snapshots){var chartData=this.callParent(arguments),forecastVelocityLineIndex=4,acceptedLineIndex=0,acceptedData,forecastData,forecastVelocityStartDateStr,i;if(console.log("forecastVelocityStartDate",this.forecastVelocityStartDate),chartData&&this.dailyVelocity&&this.forecastVelocityStartDate){console.log("runCalculation",this.dailyVelocity),forecastVelocityStartDateStr=Ext.Date.format(this.forecastVelocityStartDate,"Y-m-d"),acceptedData=chartData.series[acceptedLineIndex].data,forecastData=chartData.series[forecastVelocityLineIndex].data;var firstIndex=this._indexOfDate(chartData,forecastVelocityStartDateStr);if(-1!==firstIndex)for(forecastData[firstIndex]=acceptedData[firstIndex]+this.dailyVelocity,i=firstIndex+1;forecastData.length>i;i++)forecastData[i]=forecastData[i-1]+this.dailyVelocity;chartData.series[forecastVelocityLineIndex].data=forecastData}return chartData},_indexOfDate:function(chartData,dateStr){var date,index=-1;if(void 0===dateStr)return index;if(index=chartData.categories.indexOf(dateStr),-1===index)for(var chartDataStartDate=new Date(chartData.categories[0]);-1===index&&date>chartDataStartDate;)date=Ext.Date.add(date,Ext.Date.DAY,-1),dateStr=Ext.Date.format(date,"Y-m-d"),index=chartData.categories.indexOf(dateStr);return console.log("index",index),index}});
                Ext.define("CrossWorkspaceReleaseBurndownApp",{extend:"Rally.app.App",componentCls:"app",requires:["CrossWorkspaceBurndownCalculator","Deft.Deferred","Ext.form.field.ComboBox","Rally.data.wsapi.Store"],forecastChart:void 0,launch:function(){Deft.Chain.pipeline([this.getWorkspaceCollection,this.getReleasesInWorkspaces,this.filterLikeReleases,this.createFilteredCombobox],this)},getWorkspaceCollection:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Subscription",fetch:["Workspaces"],autoLoad:!0,listeners:{load:function(store,data){var subscription=data[0];subscription.getCollection("Workspaces").load({fetch:["ObjectID","Name","State"],filters:[{property:"State",operator:"!=",value:"Closed"}],callback:function(records){deferred.resolve(records)}})}}}),deferred.promise},getReleasesInWorkspaces:function(workspaces){return Deft.Chain.parallel(_.map(workspaces,function(workspace){return function(){var store=Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:!0,limit:1/0,context:{workspace:Rally.util.Ref.getRelativeUri(workspace),project:null}});return store.load()}}))},filterLikeReleases:function(aggregateRecords){var deferred=Ext.create("Deft.Deferred"),allReleases=_.pluck(_.flatten(aggregateRecords),"data"),releases=[],me=this;return _.map(allReleases,function(release){var likeRelease=me._isLikeReleaseInList(releases,release.Name),workspaceRef=release.Workspace._ref,objectIdHash;if(likeRelease)objectIdHash=likeRelease.ObjectID,objectIdHash[workspaceRef]||(objectIdHash[workspaceRef]=[]),objectIdHash[workspaceRef].push(release.ObjectID),likeRelease.ObjectID=objectIdHash,me._isLikeReleaseWorkspaceInList(likeRelease.Workspace,release.Workspace._refObjectName)||likeRelease.Workspace.push(release.Workspace);else{var formattedStartDate=Rally.util.DateTime.formatWithDefault(release.ReleaseStartDate),shiftedEndDate=Rally.util.DateTime.shiftTimezoneOffDate(release.ReleaseDate),formattedEndDate=Rally.util.DateTime.formatWithDefault(shiftedEndDate);objectIdHash={},objectIdHash[workspaceRef]=[release.ObjectID],releases.push({Name:release.Name,ObjectID:objectIdHash,Workspace:[release.Workspace],ReleaseStartDate:release.ReleaseStartDate,ReleaseDate:release.ReleaseDate,FormattedReleaseStartDate:formattedStartDate,FormattedReleaseDate:formattedEndDate})}}),releases=_.sortBy(releases,"Name"),deferred.resolve(releases),deferred.promise},createFilteredCombobox:function(filteredReleases){var me=this,sharedReleases=[];_.each(filteredReleases,function(release){release.Workspace.length>1&&sharedReleases.push(release)}),this.add({xtype:"combobox",fieldLabel:"Choose Release",store:Ext.create("Ext.data.Store",{data:sharedReleases,fields:["Name","ObjectID","Workspace","FormattedReleaseStartDate","FormattedReleaseDate","ReleaseStartDate","ReleaseDate"]}),displayField:"Name",valueField:"ObjectId",width:600,triggerAction:"all",mode:"local",listeners:{select:{single:!1,fn:function(combo,record){var release=record[0].data;me._createChart(release)}},change:{fn:function(combo,record){var release=record[0].data}},scope:me},listConfig:{itemTpl:new Ext.XTemplate('<div class="release-name">{Name} &nbsp; &ndash; &nbsp; </div><div class="workspace-names">( <tpl for="Workspace">{_refObjectName} </tpl>)</div><div class="release-dates">{FormattedReleaseStartDate} &nbsp; &ndash; &nbsp; {FormattedReleaseDate}</div>'),shadow:"drop"}})},_getFilters:function(objectIDs){var releaseFilter=Ext.create("Rally.data.lookback.QueryFilter",{property:"Release",operator:"in",value:objectIDs}),typeHierarchyFilter=Ext.create("Rally.data.lookback.QueryFilter",{property:"_TypeHierarchy",operator:"=",value:"HierarchicalRequirement"}),childrenFilter=Ext.create("Rally.data.lookback.QueryFilter",{property:"Children",operator:"=",value:null});return releaseFilter.and(typeHierarchyFilter).and(childrenFilter)},_getStoreConfig:function(release){var me=this,storeConfigs=[],storeConfig;console.log("RELEASE CHOOSEN",release);for(var workspace in release.ObjectID)storeConfig={filters:me._getFilters(release.ObjectID[workspace]),fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"],context:{workspace:workspace,project:null},compress:!0,useHttpPost:!0,autotload:!0,limit:1/0},storeConfigs.push(storeConfig);return storeConfigs},_createChart:function(release){var me=this,forecastVelocityStartDate,chartEndDate,userChartEndDate;me.forecastChart&&me.remove("forecastChart"),forecastVelocityStartDate=this.getSetting("forecastVelocityStartDate"),forecastVelocityStartDate&&(forecastVelocityStartDate=this.dateStringToObject(forecastVelocityStartDate)),userChartEndDate=this.getSetting("chartEndDate"),userChartEndDate&&(userChartEndDate=this.dateStringToObject(userChartEndDate)),chartEndDate=userChartEndDate?userChartEndDate:release.ReleaseDate,me.forecastChart=Ext.create("Rally.ui.chart.Chart",{itemId:"forecastChart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:me._getStoreConfig(release),calculatorType:"CrossWorkspaceBurndownCalculator",calculatorConfig:{timeZone:"GMT",completedScheduleStateNames:["Accepted"],enableProjections:!0,startDate:release.ReleaseStartDate,scopeEndDate:chartEndDate,dailyVelocity:this.dailyVelocity,forecastVelocityStartDate:forecastVelocityStartDate,selectedRelease:release},chartColors:["#005eb8","#8dc63f","#666666","#c0c0c0","#FA58F4"],chartConfig:me._getChartConfig()}),me.add(me.forecastChart)},_getChartConfig:function(){return{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"Wind River Burnup and Forecast",margin:30},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:7,title:{text:"Date",margin:12},maxPadding:.25,labels:{x:0,y:20,overflow:"justify"}},yAxis:[{title:{text:"Points"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},connectNulls:!0},column:{pointPadding:0,borderWidth:0,stacking:null,shadow:!1}}}},_isLikeReleaseInList:function(releases,releaseName){return _.find(releases,function(release){return release.Name===releaseName})},_isLikeReleaseWorkspaceInList:function(workspaces,workspaceName){return _.find(workspaces,function(workspace){return workspace._refObjectName===workspaceName})}});

            Rally.launchApp('CrossWorkspaceReleaseBurndownApp', {
                name:"CrossWorkspaceReleaseBurndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .release-name{display:inline}.workspace-names{display:inline}.release-dates{text-align:right}
    </style>
</head>
<body>
</body>
</html>
