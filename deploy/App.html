<!DOCTYPE html>
<html>
<head>
    <title>CrossWorkspaceReleaseBurndown</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CrossWorkspaceReleaseBurndownApp",{extend:"Rally.app.App",componentCls:"app",requires:["Deft.Deferred","Rally.data.custom.Store","Rally.data.wsapi.Store","Rally.ui.picker.MultiObjectPicker","CrossWorkspaceReleaseBurndownCalculator"],launch:function(){Deft.Chain.pipeline([this.getWorkspaceCollection,this.getReleasesInWorkspaces,this.createReleasePicker],this)},getWorkspaceCollection:function(){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Subscription",fetch:["Workspaces"],autoLoad:!0,listeners:{load:function(store,data){var subscription=data[0];subscription.getCollection("Workspaces").load({fetch:["ObjectID","Name","State"],filters:[{property:"State",operator:"!=",value:"Closed"}],callback:function(records){deferred.resolve(records)}})}}}),deferred.promise},getReleasesInWorkspaces:function(workspaces){var allReleases=[],deferred=Ext.create("Deft.Deferred");return Deft.Promise.all(_.map(workspaces,function(workspace){return function(){Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:!0,autoLoad:!0,context:{workspace:Rally.util.Ref.getRelativeUri(workspace),project:null},listeners:{load:function(store,data){allReleases=allReleases.concat(data),workspaces.indexOf(workspace)===workspaces.length-1&&deferred.resolve(allReleases)}}})}()})),deferred.promise},createReleasePicker:function(releases){var deferred=Ext.create("Deft.Deferred");return this.add({xtype:"rallymultiobjectpicker",fieldLabel:"Choose Releases",modelTypes:["Release"],store:Ext.create("Rally.data.custom.Store",{data:releases}),storeConfig:{context:{workspace:null,project:null}},listeners:{ready:function(){deferred.resolve()},select:function(picker,value,values){}}}),deferred.promise}});
                Ext.define("CrossWorkspaceReleaseBurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",constructor:function(config){this.initConfig(config),this.callParent(arguments)},getMetrics:function(){return[{field:"PlanEstimate",as:"Derp Points",display:"line",f:"sum"}]}});

            Rally.launchApp('CrossWorkspaceReleaseBurndownApp', {
                name:"CrossWorkspaceReleaseBurndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
